<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>lib/task/client/mocha.js - preceptor</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="shortcut icon" type="image/png" href="../assets/favicon.png">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
            
                <h1><img src="../assets/css/logo.png" title="preceptor"></h1>
            
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: 0.9.0</em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
    <h2 class="off-left">APIs</h2>
    <div id="api-tabview" class="tabview">
        <ul class="tabs">
            <li><a href="#api-classes">Classes</a></li>
            <li><a href="#api-modules">Modules</a></li>
        </ul>

        <div id="api-tabview-filter">
            <input type="search" id="api-filter" placeholder="Type to filter APIs">
        </div>

        <div id="api-tabview-panel">
            <ul id="api-classes" class="apis classes">
            
                <li><a href="../classes/AbstractClient.html">AbstractClient</a></li>
            
                <li><a href="../classes/AbstractClientDecorator.html">AbstractClientDecorator</a></li>
            
                <li><a href="../classes/AbstractForkTask.html">AbstractForkTask</a></li>
            
                <li><a href="../classes/AbstractTask.html">AbstractTask</a></li>
            
                <li><a href="../classes/AbstractTaskDecorator.html">AbstractTaskDecorator</a></li>
            
                <li><a href="../classes/Client.html">Client</a></li>
            
                <li><a href="../classes/Config.html">Config</a></li>
            
                <li><a href="../classes/Coverage.html">Coverage</a></li>
            
                <li><a href="../classes/CucumberClient.html">CucumberClient</a></li>
            
                <li><a href="../classes/CucumberTask.html">CucumberTask</a></li>
            
                <li><a href="../classes/GroupTask.html">GroupTask</a></li>
            
                <li><a href="../classes/GroupTaskDecorator.html">GroupTaskDecorator</a></li>
            
                <li><a href="../classes/IdentifierTaskDecorator.html">IdentifierTaskDecorator</a></li>
            
                <li><a href="../classes/KoboldClient.html">KoboldClient</a></li>
            
                <li><a href="../classes/KoboldTask.html">KoboldTask</a></li>
            
                <li><a href="../classes/MochaClient.html">MochaClient</a></li>
            
                <li><a href="../classes/MochaTask.html">MochaTask</a></li>
            
                <li><a href="../classes/NodeClient.html">NodeClient</a></li>
            
                <li><a href="../classes/NodeTask.html">NodeTask</a></li>
            
                <li><a href="../classes/PlainClientDecorator.html">PlainClientDecorator</a></li>
            
                <li><a href="../classes/PreceptorManager.html">PreceptorManager</a></li>
            
                <li><a href="../classes/ShellTask.html">ShellTask</a></li>
            
            </ul>

            <ul id="api-modules" class="apis modules">
            
            </ul>
        </div>
    </div>
</div>

            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
        Show:
        <label for="api-show-inherited">
            <input type="checkbox" id="api-show-inherited" checked>
            Inherited
        </label>

        <label for="api-show-protected">
            <input type="checkbox" id="api-show-protected">
            Protected
        </label>

        <label for="api-show-private">
            <input type="checkbox" id="api-show-private">
            Private
        </label>
        <label for="api-show-deprecated">
            <input type="checkbox" id="api-show-deprecated">
            Deprecated
        </label>

    </div>


            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
                        <h1 class="file-heading">File: lib/task/client/mocha.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
// Copyright 2014, Yahoo! Inc.
// Copyrights licensed under the Mit License. See the accompanying LICENSE file for terms.

var AbstractClient = require(&#x27;../../abstractClient&#x27;);
var Promise = require(&#x27;promise&#x27;);
var _ = require(&#x27;underscore&#x27;);
var utils = require(&#x27;preceptor-core&#x27;).utils;
var fs = require(&#x27;fs&#x27;);
var glob = require(&#x27;glob&#x27;);
var path = require(&#x27;path&#x27;);

var exists = fs.existsSync || path.existsSync;

Error.stackTraceLimit = Infinity;

/**
 * @class MochaClient
 * @extends AbstractClient
 * @constructor
 */
var MochaClient = AbstractClient.extend(

	{
		/**
		 * Initializes the instance
		 *
		 * @method initialize
		 */
		initialize: function () {

			var self = this;

			this.__super();

			this.getFunctions().push(function () {
				before(function (done) {
					self.processBefore().then(function () {
						done();
					}, function (err) {
						done(err);
					});
				});
				after(function (done) {
					self.processAfter().then(function () {
						done();
					}, function (err) {
						done(err);
					});
				});
				beforeEach(function (done) {
					self.processBeforeTest().then(function () {
						done();
					}, function (err) {
						done(err);
					});
				});
				afterEach(function (done) {
					self.processAfterTest().then(function () {
						done();
					}, function (err) {
						done(err);
					});
				});
			});
		},


		/**
		 * Gets the mocha configuration
		 * Overwrite this function if the mocha configuration is found somewhere else.
		 *
		 * @method getMochaConfiguration
		 * @return {object}
		 */
		getMochaConfiguration: function () {
			return this.getOptions();
		},

		/**
		 * Sets the mocha configuration
		 * Overwrite this function if the mocha configuration is found somewhere else.
		 *
		 * @method setMochaConfiguration
		 * @param {object} options
		 */
		setMochaConfiguration: function (options) {
			this._options = options;
		},


		/**
		 * Gets the reporter
		 * Mocha Option: reporter
		 *
		 * @method getReporter
		 * @return {string}
		 */
		getReporter: function () {
			return this.getMochaConfiguration().reporter;
		},

		/**
		 * Gets the UI interface (&#x27;tdd&#x27;, &#x27;bdd&#x27;)
		 * Mocha Option: ui
		 *
		 * @method getUi
		 * @return {string}
		 */
		getUi: function () {
			return this.getMochaConfiguration().ui;
		},

		/**
		 * Should colors be used in output?
		 * Mocha Option: colors
		 *
		 * @method useColors
		 * @return {boolean}
		 */
		useColors: function () {
			return this.getMochaConfiguration().colors;
		},

		/**
		 * Output inline diffs
		 * Mocha Option: inline-diffs
		 *
		 * @method useInlineDiffs
		 * @return {boolean}
		 */
		useInlineDiffs: function () {
			return this.getMochaConfiguration().inlineDiffs;
		},

		/**
		 * Gets the threshold for slow tests
		 * Mocha Option: slow
		 *
		 * @method getSlowThreshold
		 * @return {int}
		 */
		getSlowThreshold: function () {
			return this.getMochaConfiguration().slow;
		},

		/**
		 * Should time-outs be observed?
		 * Mocha Option: [no-]timeouts
		 *
		 * @method useTimeOuts
		 * @return {boolean}
		 */
		useTimeOuts: function () {
			return this.getMochaConfiguration().timeOuts;
		},

		/**
		 * Gets the threshold for too slow test-suites
		 * Mocha Option: timeout
		 *
		 * @method getTimeOut
		 * @return {int}
		 */
		getTimeOut: function () {
			return this.getMochaConfiguration().timeOut;
		},

		/**
		 * Should mocha bail on first error?
		 * Mocha Option: bail
		 *
		 * @method shouldBail
		 * @return {boolean}
		 */
		shouldBail: function () {
			return this.getMochaConfiguration().bail;
		},

		/**
		 * Gets the test filter
		 * Mocha Option: grep
		 *
		 * @method getGrep
		 * @return {string|boolean}
		 */
		getGrep: function () {
			return this.getMochaConfiguration().grep;
		},

		/**
		 * Should the test sequence inverted?
		 * Mocha Option: invert
		 *
		 * @method shouldInvert
		 * @return {boolean}
		 */
		shouldInvert: function () {
			return this.getMochaConfiguration().invert;
		},

		/**
		 * Should mocha check for leaks
		 * Mocha Option: check-leaks
		 *
		 * @method shouldCheckLeaks
		 * @return {boolean}
		 */
		shouldCheckLeaks: function () {
			return this.getMochaConfiguration().checkLeaks;
		},

		/**
		 * Gets the reporter
		 * Mocha Option: async-only
		 *
		 * @method useAsyncOnly
		 * @return {boolean}
		 */
		useAsyncOnly: function () {
			return this.getMochaConfiguration().asyncOnly;
		},

		/**
		 * Gets the list of defined globals
		 * Mocha Option: globals
		 *
		 * @method getGlobals
		 * @return {string[]}
		 */
		getGlobals: function () {
			return this.getMochaConfiguration().globals;
		},

		/**
		 * Gets the path of all tests
		 * Mocha Option: &lt;last parameters&gt;
		 *
		 * @method getPaths
		 * @return {string[]}
		 */
		getPaths: function () {
			return this.getMochaConfiguration().paths;
		},

		/**
		 * Gets a list of functions to execute before the tests
		 * Mocha Option: &lt;does not exist&gt;
		 *
		 * @method getFunctions
		 * @return {function[]}
		 */
		getFunctions: function () {
			return this.getMochaConfiguration().functions;
		},

		/**
		 * Should the test-search be recursive?
		 * Mocha Option: recursive
		 *
		 * @method getRecursive
		 * @return {boolean}
		 */
		getRecursive: function () {
			return this.getMochaConfiguration().recursive;
		},

		/**
		 * List of files to be required before the tests are run
		 * Mocha Option: require
		 *
		 * @method getRequire
		 * @return {string[]}
		 */
		getRequire: function () {
			return this.getMochaConfiguration().require;
		},

		/**
		 * Should tests be sorted after gathering and before executing?
		 * Mocha Option: sort
		 *
		 * @method shouldSort
		 * @return {boolean}
		 */
		shouldSort: function () {
			return this.getMochaConfiguration().sort;
		},


		/**
		 * Execute client
		 *
		 * @method run
		 * @param {string} parentId
		 * @return {Promise}
		 */
		run: function (parentId) {

			return new Promise(function (resolve, reject) {

				var instance,
					hook,
					done;

				hook = this.getReportManager().loadHook(&#x27;mocha&#x27;, parentId);

				this.getReportManager().message().start();
				done = function () {
					this.getReportManager().message().stop();
					this.getReportManager().message().complete();
				}.bind(this);

				instance = this._runMocha(this.getMochaConfiguration(), function () {
					done();
					resolve.apply(this, arguments);
				}, function () {
					done();
					reject.apply(this, arguments);
				});
				hook(instance);

			}.bind(this));
		},

		/**
		 * Runs mocha tests, self-contained
		 *
		 * @method _runMocha
		 * @param {object} options
		 * @param {string} options.reporter
		 * @param {string} options.ui
		 * @param {boolean} options.colors
		 * @param {boolean} options.inlineDiffs
		 * @param {int} options.slow
		 * @param {boolean} options.timeOuts
		 * @param {int} options.timeOut
		 * @param {boolean} options.bail
		 * @param {boolean|string} options.grep
		 * @param {boolean} options.invert
		 * @param {boolean} options.checkLeaks
		 * @param {boolean} options.asyncOnly
		 * @param {string[]} options.globals
		 * @param {string[]} [options.paths=[&#x27;test&#x27;]]
		 * @param {functions[]} options.functions
		 * @param {boolean} options.recursive
		 * @param {string|string[]} options.require
		 * @param {boolean} options.sort
		 * @param {function} success
		 * @param {function} failure
		 * @return {*}
		 * @private
		 */
		_runMocha: function (options, success, failure) {

			var files = [],
				mocha,
				runner,
				paths,
				mochaLoadFiles,
				cwd = process.cwd(),
				Mocha = require(&#x27;mocha&#x27;);

			options = options || {};

			mocha = new Mocha();
			mochaLoadFiles = mocha.loadFiles;

			module.paths.push(cwd, path.join(cwd, &#x27;node_modules&#x27;));

			// --reporter
			mocha.reporter(options.reporter);

			// --ui
			mocha.ui(options.ui);

			// --colors
			if (options.colors === false) {
				mocha.useColors(false);
			} else {
				mocha.useColors(true);
			}

			// --inline-diffs
			mocha.useInlineDiffs(options.inlineDiffs);

			// --slow &lt;ms&gt;
			mocha.suite.slow(options.slow);

			// --[no-]timeouts
			mocha.enableTimeouts(options.timeOuts);

			// --timeout
			mocha.suite.timeout(options.timeOut);

			// --bail
			mocha.suite.bail(options.bail);

			// --grep
			if (options.grep) {
				mocha.grep(new RegExp(options.grep));
			}

			// --invert
			if (options.invert) {
				mocha.invert();
			}

			// --check-leaks
			if (options.checkLeaks) {
				mocha.checkLeaks();
			}

			// --async-only
			if (options.asyncOnly) {
				mocha.asyncOnly();
			}

			// --globals
			mocha.globals(options.globals);

			// Find all test-files
			paths = options.paths;
			if ((paths.length === 0) &amp;&amp; (options.functions.length &gt; 0)) {
				paths = [&#x27;test&#x27;];
			}
			_.each(paths, function(path) {
				files = files.concat(lookupFiles(path, options.recursive));
			});

			if (options.require) {
				_.each(options.require, function (requireFile) {
					require(path.resolve(requireFile));
				});
			}

			// Resolve to full path
			files = files.map(function (filePath) {
				return path.resolve(filePath);
			});

			// --sort
			if (options.sort) {
				files.sort();
			}

			if ((files.length === 0) &amp;&amp; (options.functions.length &gt; 0)) {
				files.push(path.join(__dirname, &#x27;resources&#x27;, &#x27;empty.js&#x27;));
			}

			// Load files
			mocha.files = files;

			// Add prepared functions instead of files
			if (options.functions) {
				mocha.loadFiles = function () {

					// Load the functions
					_.each(options.functions, function (currentFn, index) {
						var fileName = currentFn.name || &#x27;function-&#x27; + index;
						mocha.suite.emit(&#x27;pre-require&#x27;, global, fileName, mocha);
						mocha.suite.emit(&#x27;require&#x27;, (_.isString(currentFn) ? require(currentFn) : currentFn()), fileName, mocha);
						mocha.suite.emit(&#x27;post-require&#x27;, global, fileName, mocha);
					});

					// Load all the files
					mochaLoadFiles.apply(this, arguments);

					// Add the functions as &quot;files&quot;
					_.each(options.functions, function (currentFn, index) {
						var fileName = currentFn.name || &#x27;function-&#x27; + index;
						mocha.files.push(fileName);
					});
				};
			}

			// Run mocha tests
			runner = mocha.run(function (code) {
				if (code === 0) {
					success(code);
				} else {
					failure(new Error(&#x27;Failed&#x27;));
				}
			});

			process.on(&#x27;SIGINT&#x27;, function() {
				runner.abort();
			});

			/**
			 * Lookup all files in the path given
			 *
			 * @method lookupFiles
			 * @param {string} currentPath
			 * @param {boolean} [recursive=false]
			 * @return {string[]}
			 * @private
			 */
			function lookupFiles (currentPath, recursive) {

				var files = [],
					stat;

				if (!exists(currentPath)) {

					if (exists(currentPath + &#x27;.js&#x27;)) {
						currentPath += &#x27;.js&#x27;

					} else {
						files = glob.sync(currentPath);
						if (!files.length) {
							throw new Error(&quot;cannot resolve path (or pattern) &#x27;&quot; + currentPath + &quot;&#x27;&quot;);
						}
						return files;
					}
				}

				stat = fs.statSync(currentPath);
				if (stat.isFile()) {
					return [currentPath];

				} else {

					fs.readdirSync(currentPath).forEach(function (file) {
						var stat;

						file = path.join(currentPath, file);

						stat = fs.statSync(file);
						if (stat.isDirectory()) {

							if (recursive) {
								files = files.concat(lookupFiles(file, recursive));
							}

						} else if (stat.isFile() &amp;&amp; (path.basename(file)[0] !== &#x27;.&#x27;)) {
							files.push(file);
						}
					});

					return files;
				}
			}

			return runner;
		}
	});

module.exports = MochaClient;

    </pre>
</div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
